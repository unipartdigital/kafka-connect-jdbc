language: java

jdk: openjdk8

# Note: .travis/set_env.sh exports some environment variables *common* to build deploy steps
before_install:
  - source .travis/set_env.sh

before_deploy:
  - source .travis/set_env.sh
  - docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}

script: .travis/build.sh ${DOCKERHUB_REPO} ${JAR_VERSION}

# Note: pom.xml version is updated as part of ./travis/build.sh script to ensure the jar version matches the Docker
# image tag - this change is *not* committed automatically as part of the build
deploy:
  # Push a `-latest` image for our `5.4.1-post` branch with patches to upstream 5.4.1
  - provider: script
    skip_cleanup: true
    script: .travis/docker_release.sh ${DOCKERHUB_REPO}:latest ${DOCKERHUB_REPO}:5.4.1-latest
    on:
      branch: 5.4.1-post
  # Push an image for git tags (e.g. our patched 'release" of an upstream version)
  # See comment in pom.xml for naming convention
  - provider: script
    skip_cleanup: true
    script: .travis/docker_release.sh ${DOCKERHUB_REPO}:latest ${DOCKERHUB_REPO}:${JAR_VERSION}
    on:
      tags: true

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.m2
